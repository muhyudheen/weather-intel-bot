<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather Intel Bot</title>
  <style>
    /* â”€â”€ reset & base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    /* â”€â”€ app shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app {
      width: 100%;
      max-width: 700px;
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 1.5rem;
      display: flex;
      flex-direction: column;
      height: 92vh;
      overflow: hidden;
      box-shadow: 0 25px 60px rgba(0,0,0,0.4);
    }

    /* â”€â”€ header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      padding: 1.1rem 1.4rem;
      background: rgba(255,255,255,0.05);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    header .logo { font-size: 1.8rem; }
    header h1 { font-size: 1.1rem; font-weight: 700; color: #fff; }
    header p  { font-size: 0.72rem; color: rgba(255,255,255,0.55); margin-top: 1px; }

    /* â”€â”€ messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      scroll-behavior: smooth;
    }
    #messages::-webkit-scrollbar { width: 5px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

    /* â”€â”€ message rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .row { display: flex; gap: 0.6rem; align-items: flex-end; }
    .row.user  { flex-direction: row-reverse; }
    .row.bot   { flex-direction: row; }

    .avatar {
      width: 34px; height: 34px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem;
      flex-shrink: 0;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.12);
    }

    /* â”€â”€ bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .bubble {
      max-width: 82%;
      padding: 0.75rem 1rem;
      border-radius: 1.1rem;
      line-height: 1.55;
      font-size: 0.88rem;
      white-space: pre-wrap;
    }
    .row.user .bubble {
      background: linear-gradient(135deg, #0EA5E9, #2563EB);
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .row.bot .bubble {
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.92);
      border-bottom-left-radius: 4px;
    }

    /* â”€â”€ weather card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .weather-card {
      background: linear-gradient(135deg, rgba(14,165,233,0.25), rgba(37,99,235,0.2));
      border: 1px solid rgba(14,165,233,0.35);
      border-radius: 1rem;
      padding: 1rem 1.2rem;
      margin-top: 0.5rem;
      color: #fff;
    }
    .weather-card .city-line {
      display: flex; align-items: center; gap: 0.4rem;
      font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 0.6rem;
    }
    .weather-card .main-temp {
      display: flex; align-items: flex-start; gap: 0.6rem; margin-bottom: 0.7rem;
    }
    .weather-card .emoji-big { font-size: 2.8rem; line-height: 1; }
    .weather-card .temp-block .temp {
      font-size: 2.6rem; font-weight: 700; line-height: 1;
    }
    .weather-card .temp-block .condition {
      font-size: 0.82rem; color: rgba(255,255,255,0.65); margin-top: 2px;
    }
    .weather-card .stats {
      display: flex; gap: 0.6rem; flex-wrap: wrap; margin-top: 0.6rem;
    }
    .weather-card .stat {
      background: rgba(255,255,255,0.1);
      border-radius: 0.6rem;
      padding: 0.35rem 0.65rem;
      font-size: 0.76rem;
      color: rgba(255,255,255,0.8);
      display: flex; align-items: center; gap: 0.3rem;
    }

    /* â”€â”€ forecast strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .forecast-strip {
      display: flex; gap: 0.5rem; overflow-x: auto; margin-top: 0.7rem;
      padding-bottom: 0.3rem;
    }
    .forecast-strip::-webkit-scrollbar { height: 4px; }
    .forecast-strip::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
    .forecast-day {
      flex: 0 0 78px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 0.75rem;
      padding: 0.5rem 0.4rem;
      text-align: center;
      font-size: 0.72rem;
      color: rgba(255,255,255,0.8);
    }
    .forecast-day .f-emoji { font-size: 1.5rem; margin: 0.2rem 0; }
    .forecast-day .f-day   { font-weight: 600; color: #fff; margin-bottom: 0.2rem; }
    .forecast-day .f-range { font-size: 0.68rem; color: rgba(255,255,255,0.55); }
    .forecast-day .f-rain  { font-size: 0.65rem; color: #7dd3fc; margin-top: 0.15rem; }

    /* â”€â”€ typing indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .typing { display: flex; gap: 4px; align-items: center; padding: 0.75rem 1rem; }
    .typing span {
      width: 7px; height: 7px; background: rgba(255,255,255,0.55);
      border-radius: 50%; animation: bounce 1.2s infinite;
    }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40%           { transform: translateY(-7px); }
    }

    /* â”€â”€ input area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #input-area {
      padding: 0.9rem 1.1rem;
      border-top: 1px solid rgba(255,255,255,0.08);
      display: flex; gap: 0.6rem; align-items: center;
      background: rgba(0,0,0,0.15);
    }
    #input-area input {
      flex: 1;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 0.8rem;
      padding: 0.65rem 1rem;
      color: #fff;
      font-size: 0.9rem;
      outline: none;
      transition: border-color .2s;
    }
    #input-area input::placeholder { color: rgba(255,255,255,0.35); }
    #input-area input:focus { border-color: rgba(14,165,233,0.6); }
    #input-area button {
      background: linear-gradient(135deg, #0EA5E9, #2563EB);
      border: none; border-radius: 0.8rem;
      width: 42px; height: 42px;
      cursor: pointer; font-size: 1.1rem;
      display: flex; align-items: center; justify-content: center;
      transition: opacity .2s;
    }
    #input-area button:hover   { opacity: 0.85; }
    #input-area button:disabled { opacity: 0.45; cursor: not-allowed; }

    /* â”€â”€ suggestions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #suggestions {
      display: flex; flex-wrap: wrap; gap: 0.45rem;
      padding: 0 1.1rem 0.7rem;
    }
    .suggestion {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 2rem;
      padding: 0.3rem 0.8rem;
      font-size: 0.75rem;
      color: rgba(255,255,255,0.75);
      cursor: pointer;
      transition: background .2s;
    }
    .suggestion:hover { background: rgba(255,255,255,0.16); }

    /* â”€â”€ ambiguity badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ambiguous-note {
      font-size: 0.72rem;
      color: #fbbf24;
      font-style: italic;
      margin-bottom: 0.4rem;
    }
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="logo">ğŸŒ¤ï¸</div>
    <div>
      <h1>Weather Intel Bot</h1>
      <p>Ask me about weather anywhere in the world</p>
    </div>
  </header>

  <div id="messages"></div>

  <div id="suggestions">
    <span class="suggestion">â˜€ï¸ Weather in Delhi</span>
    <span class="suggestion">ğŸŒ§ï¸ Will it rain in London?</span>
    <span class="suggestion">â„ï¸ 7-day forecast for Tokyo</span>
    <span class="suggestion">ğŸŒ¡ï¸ How hot is Dubai right now?</span>
    <span class="suggestion">ğŸŒªï¸ Wind speed in Chicago</span>
  </div>

  <div id="input-area">
    <input id="user-input" type="text" placeholder="Ask about weather anywhereâ€¦" autocomplete="off" />
    <button id="send-btn">â¤</button>
  </div>
</div>

<script>
  const DAY_NAMES = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

  function todayDayNames(n) {
    const now = new Date();
    return Array.from({length: n}, (_, i) => {
      const d = new Date(now); d.setDate(d.getDate() + i);
      return i === 0 ? "Today" : DAY_NAMES[d.getDay()];
    });
  }

  function escHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function buildWeatherCard(data, city, country, qtype) {
    const cur = data.current;
    const isAmbiguous = window._lastAmbiguous;
    const note = window._lastNote;

    let html = `<div class="weather-card">`;

    if (note) html += `<div class="ambiguous-note">âš ï¸ ${escHtml(note)}</div>`;

    html += `<div class="city-line">ğŸ“ ${escHtml(city)}, ${escHtml(country)}</div>`;

    if (cur) {
      html += `
        <div class="main-temp">
          <div class="emoji-big">${cur.emoji}</div>
          <div class="temp-block">
            <div class="temp">${cur.temperature}Â°C</div>
            <div class="condition">${escHtml(cur.condition)}</div>
          </div>
        </div>
        <div class="stats">
          <div class="stat">ğŸŒ¡ï¸ Feels like ${cur.feels_like}Â°C</div>
          <div class="stat">ğŸ’§ Humidity ${cur.humidity}%</div>
          <div class="stat">ğŸ’¨ Wind ${cur.wind_speed_kmh} km/h ${escHtml(cur.wind_direction)}</div>
          ${cur.uv_index !== undefined ? `<div class="stat">â˜€ï¸ UV ${cur.uv_index}</div>` : ''}
          ${cur.precipitation_mm > 0 ? `<div class="stat">ğŸŒ§ï¸ Precip ${cur.precipitation_mm} mm</div>` : ''}
        </div>`;
    }

    if (data.days && data.days.length > 0) {
      const dayNames = todayDayNames(data.days.length);
      html += `<div class="forecast-strip">`;
      data.days.forEach((d, i) => {
        html += `
          <div class="forecast-day">
            <div class="f-day">${dayNames[i]}</div>
            <div class="f-emoji">${d.emoji}</div>
            <div class="f-range">${d.temp_max}Â° / ${d.temp_min}Â°</div>
            <div class="f-rain">ğŸŒ§ï¸ ${d.rain_probability}%</div>
          </div>`;
      });
      html += `</div>`;
    }

    html += `</div>`;
    return html;
  }

  // â”€â”€ render helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function appendMessage(role, text, extraHtml = '') {
    const msgs = document.getElementById('messages');
    const row  = document.createElement('div');
    row.className = `row ${role}`;

    const avatarEmoji = role === 'user' ? 'ğŸ§‘' : 'ğŸ¤–';
    const noteStripped = text.replace(/^_Note:.*?_\n\n/, '');

    row.innerHTML = `
      <div class="avatar">${avatarEmoji}</div>
      <div>
        <div class="bubble">${escHtml(noteStripped)}</div>
        ${extraHtml}
      </div>`;
    msgs.appendChild(row);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function showTyping() {
    const msgs = document.getElementById('messages');
    const row  = document.createElement('div');
    row.className = 'row bot'; row.id = 'typing-row';
    row.innerHTML = `
      <div class="avatar">ğŸ¤–</div>
      <div class="bubble typing"><span></span><span></span><span></span></div>`;
    msgs.appendChild(row);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function removeTyping() {
    const el = document.getElementById('typing-row');
    if (el) el.remove();
  }

  // â”€â”€ send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function sendMessage(msg) {
    msg = msg.trim();
    if (!msg) return;

    const input  = document.getElementById('user-input');
    const btn    = document.getElementById('send-btn');
    const sugg   = document.getElementById('suggestions');

    input.value = '';
    btn.disabled = true;
    sugg.style.display = 'none';

    appendMessage('user', msg);
    showTyping();

    try {
      const res  = await fetch('/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: msg}),
      });
      const data = await res.json();

      window._lastAmbiguous = data.ambiguous || false;
      window._lastNote      = null;

      // strip _Note:_ prefix from response text
      const noteMatch = data.response && data.response.match(/^_Note: (.*?)_\n\n/);
      if (noteMatch) window._lastNote = noteMatch[1];

      removeTyping();

      let cardHtml = '';
      if (data.weather_data) {
        cardHtml = buildWeatherCard(data.weather_data, data.city || '', data.country || '', data.query_type);
      }

      appendMessage('bot', data.response || 'No response.', cardHtml);
    } catch (e) {
      removeTyping();
      appendMessage('bot', 'âš ï¸ Something went wrong. Please check your API key and try again.');
    }

    btn.disabled = false;
    input.focus();
  }

  // â”€â”€ wire up UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  document.getElementById('send-btn').addEventListener('click', () => {
    sendMessage(document.getElementById('user-input').value);
  });

  document.getElementById('user-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') sendMessage(e.target.value);
  });

  document.querySelectorAll('.suggestion').forEach(s => {
    s.addEventListener('click', () => sendMessage(s.textContent.replace(/^[^\w]+/, '')));
  });

  // â”€â”€ welcome message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  appendMessage('bot', "Hello! ğŸ‘‹ I'm your Weather Intel Bot. Ask me about the current weather, a 7-day forecast, UV index, humidity â€” anything weather-related for any city in the world!");
</script>
</body>
</html>
